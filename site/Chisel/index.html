
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../GDB/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.7">
    
    
      
        <title>Chisel - Useful Utility Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f2e4d321.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Useful Utility Tutorial" class="md-header__button md-logo" aria-label="Useful Utility Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Useful Utility Tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chisel
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Useful Utility Tutorial" class="md-nav__button md-logo" aria-label="Useful Utility Tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Useful Utility Tutorial
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Chisel
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Chisel
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      基本组成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基本组成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      数据类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      组合逻辑
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bundle-vec" class="md-nav__link">
    <span class="md-ellipsis">
      Bundle 和 Vec 结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bundle 和 Vec 结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bundle" class="md-nav__link">
    <span class="md-ellipsis">
      Bundle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vec" class="md-nav__link">
    <span class="md-ellipsis">
      Vec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#combinational-vec" class="md-nav__link">
    <span class="md-ellipsis">
      Combinational Vec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-vec" class="md-nav__link">
    <span class="md-ellipsis">
      Register Vec
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bundle-vec_1" class="md-nav__link">
    <span class="md-ellipsis">
      Bundle 和 Vec 结合
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wire-reg-io" class="md-nav__link">
    <span class="md-ellipsis">
      Wire, Reg 和 IO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module" class="md-nav__link">
    <span class="md-ellipsis">
      Module 类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bulk-connections" class="md-nav__link">
    <span class="md-ellipsis">
      Bulk Connections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chisel" class="md-nav__link">
    <span class="md-ellipsis">
      内嵌非 Chisel 代码
    </span>
  </a>
  
    <nav class="md-nav" aria-label="内嵌非 Chisel 代码">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extmodule" class="md-nav__link">
    <span class="md-ellipsis">
      ExtModule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blackbox" class="md-nav__link">
    <span class="md-ellipsis">
      BlackBox
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      组合逻辑基本模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组合逻辑基本模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      组合逻辑电路
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      多选器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      解码器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      编码器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      仲裁器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      优先编码器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      比较器
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      时序逻辑基本模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="时序逻辑基本模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      计数器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      计时器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      脉冲宽度调制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      移位寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      内存
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../GDB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GDB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Makefile/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Makefile
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../VCS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VCS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Verilator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Verilator
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      基本组成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基本组成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      数据类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      组合逻辑
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bundle-vec" class="md-nav__link">
    <span class="md-ellipsis">
      Bundle 和 Vec 结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Bundle 和 Vec 结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bundle" class="md-nav__link">
    <span class="md-ellipsis">
      Bundle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vec" class="md-nav__link">
    <span class="md-ellipsis">
      Vec
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Vec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#combinational-vec" class="md-nav__link">
    <span class="md-ellipsis">
      Combinational Vec
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-vec" class="md-nav__link">
    <span class="md-ellipsis">
      Register Vec
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bundle-vec_1" class="md-nav__link">
    <span class="md-ellipsis">
      Bundle 和 Vec 结合
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wire-reg-io" class="md-nav__link">
    <span class="md-ellipsis">
      Wire, Reg 和 IO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module" class="md-nav__link">
    <span class="md-ellipsis">
      Module 类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bulk-connections" class="md-nav__link">
    <span class="md-ellipsis">
      Bulk Connections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chisel" class="md-nav__link">
    <span class="md-ellipsis">
      内嵌非 Chisel 代码
    </span>
  </a>
  
    <nav class="md-nav" aria-label="内嵌非 Chisel 代码">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extmodule" class="md-nav__link">
    <span class="md-ellipsis">
      ExtModule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blackbox" class="md-nav__link">
    <span class="md-ellipsis">
      BlackBox
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      组合逻辑基本模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组合逻辑基本模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      组合逻辑电路
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      多选器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      解码器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      编码器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      仲裁器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      优先编码器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      比较器
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      时序逻辑基本模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="时序逻辑基本模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      计数器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      计时器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      脉冲宽度调制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      移位寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      内存
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Chisel</h1>

<h2 id="_1">介绍<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Chisel是一个**硬件构建语言**（Hardware Construct Language），它是 Scala 的一个库。Chisel 的设计目标是利用 Scala 的强大特性，同时又能够生成高效的硬件描述。Chisel 的设计思想是将硬件描述看作是一个函数式的数据结构，这样可以利用 Scala 的函数式特性来描述硬件。</p>
<p>Chisel 教程各个章节的内容如下：</p>
<ul>
<li><a href="#基本组成">基本组成</a>：基本的数据类型、组合逻辑、寄存器、Bundle 和 Vec 结构、Wire, Reg 和 IO。</li>
<li><a href="#模块">模块</a>：介绍 Module 类。</li>
<li><a href="#组合逻辑基本模块">组合逻辑基本模块</a>：一些简单的组合逻辑模块的实例。</li>
<li><a href="#时序逻辑基本模块">时序逻辑基本模块</a>：一些简单的时序逻辑模块的实例。</li>
<li>未完待续。</li>
</ul>
<h2 id="_2">基本组成<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">数据类型<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>Chisel 有三种数据结构：<code>Bits</code>，<code>UInt</code> 和 <code>SInt</code>。
这三种数据结构都表示一个比特向量（vector of bits）。
<code>Bits</code> 是一个抽象类，<code>UInt</code> 和 <code>SInt</code> 是 <code>Bits</code> 的子类。
一般而言，我们不会使用 <code>Bits</code>。</p>
<div class="highlight"><pre><span></span><code><span class="nc">Bits</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span><span class="w">      </span><span class="c1">// 8-bit vector of bits</span>
<span class="nc">UInt</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span><span class="w">      </span><span class="c1">// 8-bit unsigned integer</span>
<span class="nc">SInt</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span><span class="w">     </span><span class="c1">// 10-bit signed integer</span>
</code></pre></div>
<p>Chisel 使用 <code>Width</code> 类型来表示比特向量的长度。
<code>n.W</code> 将 Scala 整数 <code>n</code> 转换为 Chisel 的 <code>Width</code> 类型。</p>
<p>如下是一些数据类型实例：</p>
<div class="highlight"><pre><span></span><code><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="w">                 </span><span class="c1">// defines a UInt constant of 0</span>
<span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="nc">S</span><span class="w">                </span><span class="c1">// defines a SInt constant of -3</span>
<span class="mi">3</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span><span class="w">            </span><span class="c1">// a 4-bit constant of 3</span>

<span class="s">&quot;hff&quot;</span><span class="p">.</span><span class="nc">U</span><span class="w">             </span><span class="c1">// hexadecimal representation of 255</span>
<span class="s">&quot;o377&quot;</span><span class="p">.</span><span class="nc">U</span><span class="w">            </span><span class="c1">// octal representation of 255</span>
<span class="s">&quot;b1111_1111&quot;</span><span class="p">.</span><span class="nc">U</span><span class="w">      </span><span class="c1">// binary representation of 255, the underscore is ignored</span>
</code></pre></div>
<p>！！！注意：定义宽度时不能遗漏 <code>.W</code>。 <code>1.U(32)</code> 并不代表 32 位宽的 1。
表达式 <code>(32)</code> 被解释为第 32 位，所以 <code>1.U(32)</code> 结果是 0。</p>
<p>Chisel 会自动推断常量的位宽，如果没有指定位宽，那么 Chisel 会默认使用能表示该常数的最小位宽。
例如，<code>3.U</code> 会被推断为 <code>3.U(2.W)</code>，因为 3 可以用 2 位表示。
尽管 Chisel 会推断信号所需的位宽，但在创建硬件对象时指定位宽是一个很好的习惯。</p>
<p>为了表示逻辑值，Chisel 定义了 <code>Bool</code> 类型。
以下代码将 Scala 布尔常量 true 和 false 转换为 Chisel <code>Bool</code> 常量。</p>
<div class="highlight"><pre><span></span><code><span class="kc">true</span><span class="p">.</span><span class="nc">B</span>
<span class="kc">false</span><span class="p">.</span><span class="nc">B</span>
</code></pre></div>
<h3 id="_4">组合逻辑<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p><img alt="operator" src="../img/operator.png" />
<img alt="operator2" src="../img/operator2.png" /></p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c</span>
</code></pre></div>
<p>该电路描述可以用于向量，而不仅仅是与 AND 和 OR 电路组合的 Wire。</p>
<p>对于加法和减法，运算的结果位宽是源操作数的最大宽度；对于乘法，结果位宽是两个操作数位宽之和；对于除法和取模，通常是分子的位宽。</p>
<p>数据的截取、拼接、扩展等操作如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span><span class="w">                    </span><span class="c1">// sign bit of x</span>
<span class="kd">val</span><span class="w"> </span><span class="n">lowByte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largeWord</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">       </span><span class="c1">// low byte of largeWord</span>
<span class="kd">val</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">highByte</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">lowByte</span><span class="w">      </span><span class="c1">// concatenation, the same as Cat(highByte, lowByte)</span>
</code></pre></div>
<h3 id="_5">寄存器<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>Chisel 中的寄存器**隐式连接**到全局时钟并在上升沿更新。
如果在声明寄存器时提供了初始化值，它将连接到全局的**同步复位**信号。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span><span class="w">     </span><span class="c1">// 8-bit register, initialized with 0 at reset</span>
<span class="n">reg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">d</span><span class="w">                        </span><span class="c1">// connect an input to the register</span>
<span class="kd">val</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg</span><span class="w">                     </span><span class="c1">// the output of the register can be used just with the name in an expression</span>
</code></pre></div>
<p>也可以在定义寄存器的时候指定其输入：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">nextReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="w">        </span><span class="c1">// register with next value of d</span>
</code></pre></div>
<p>同时指定初始值和输入：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">bothReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span><span class="w">   </span><span class="c1">// register with next value of d, initialized with 0</span>
</code></pre></div>
<p>具有使能信号的寄存器也很常见，Chisel 的定义如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">resetEnableReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegEnable</span><span class="w"> </span><span class="p">(</span><span class="n">inVal</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">),</span><span class="w"> </span><span class="n">enable</span><span class="p">)</span>
</code></pre></div>
<p>第一个参数是输入信号，第二个参数是初始化值，第三个参数是使能信号。</p>
<blockquote>
<p>有关 <code>Mux</code> 的介绍，请参考<a href="#多选器">多选器</a>。</p>
</blockquote>
<h3 id="bundle-vec">Bundle 和 Vec 结构<a class="headerlink" href="#bundle-vec" title="Permanent link">&para;</a></h3>
<p>Chisel 提供了两种聚合（aggregate）数据结构来组织多个信号：<code>Bundle</code> 和 <code>Vec</code>。
<code>Bundle</code> 将不同类型的信号分为一组。
<code>Vec</code> 表示相同类型的信号（元素）的可索引集合。</p>
<h4 id="bundle">Bundle<a class="headerlink" href="#bundle" title="Permanent link">&para;</a></h4>
<p>我们可以定义一个 <code>Bundle</code> 类的继承，并使用 <code>val</code> 定义不同字段（field）。
要使用 <code>Bundle</code>，我们需要用 <code>new</code> 创建它并将其封装到 <code>Wire</code> 中。
使用<code>.</code>符号访问其中的字段。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Channel</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">valid</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">val</span><span class="w"> </span><span class="n">ch</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Channel</span><span class="p">())</span>
<span class="n">ch</span><span class="p">.</span><span class="n">data</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span>
<span class="n">ch</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="p">.</span><span class="nc">B</span>

<span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">.</span><span class="n">valid</span>

<span class="kd">val</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="w">    </span><span class="c1">// A bundle can be referenced as a whole</span>
</code></pre></div>
<blockquote>
<p>点表示法（dot notation）在面向对象语言中很常见，其中 <code>x.y</code> 表示 <code>x</code> 是对象的引用，<code>y</code> 是该对象的字段。</p>
</blockquote>
<h4 id="vec">Vec<a class="headerlink" href="#vec" title="Permanent link">&para;</a></h4>
<h5 id="combinational-vec">Combinational Vec<a class="headerlink" href="#combinational-vec" title="Permanent link">&para;</a></h5>
<p><code>Vec</code> 是通过调用带有两个参数的构造函数来创建的：元素的数量和元素的类型。Combinational Vec 需要封装成 <code>Wire</code>。
通过使用索引访问各个元素，封装在 <code>Wire</code> 中的 <code>Vec</code> 只是一个多路复用器（multiplexer）。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="nc">Vec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)))</span>

<span class="n">v</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span>
<span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span>
<span class="n">v</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="nc">U</span>

<span class="kd">val</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>
<p>我们可以使用 <code>VecInit</code> 设置 <code>Vec</code> 的默认值。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">defVec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VecInit</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">defVecSig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VecInit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">)</span>
</code></pre></div>
<h5 id="register-vec">Register Vec<a class="headerlink" href="#register-vec" title="Permanent link">&para;</a></h5>
<p>我们可以使用 <code>Vec</code> 来定义寄存器数组。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">registerFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">Vec</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">)))</span>
<span class="n">registerFile</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">dIn</span>
<span class="kd">val</span><span class="w"> </span><span class="n">dOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">registerFile</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>
<p>向量寄存器也可以被初始化。
初始化的值这就是寄存器复位的值。
例如，为了初始化寄存器堆（register file），我们使用带有初始值的 <code>VecInit</code>，并将其封装到 <code>RegInit</code> 中。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">initReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">VecInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">W</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="nc">U</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">resetVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initReg</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
<span class="n">initReg</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">d</span>
<span class="n">initReg</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">e</span>
<span class="n">initReg</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">f</span>
</code></pre></div>
<p>如果我们想将一个寄存器堆所有元素的初始值设为为相同的值，我们可以使用 Scala 序列 <code>Seq</code>。
<code>Seq</code> 包含一个创建函数 <code>fill</code>，它用相同的值初始化序列。
<code>VecInit</code> 可以使用包含 Chisel 类型的 <code>Seq</code> 来构造。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">resetRegFile</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nc">RegInit</span><span class="p">(</span><span class="nc">VecInit</span><span class="p">(</span><span class="nc">Seq</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">32</span><span class="p">)(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))))</span><span class="w">   </span><span class="c1">// 32-bit register file, initialized with 0</span>
<span class="kd">val</span><span class="w"> </span><span class="n">rdRegFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resetRegFile</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
</code></pre></div>
<h4 id="bundle-vec_1">Bundle 和 Vec 结合<a class="headerlink" href="#bundle-vec_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">vecBundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="nc">Vec</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Channel</span><span class="p">()))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BundleVec</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="kd">val</span><span class="w"> </span><span class="n">field</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>当我们想要一个有复位值的 <code>Bundle</code> 类型的寄存器时，我们首先创建该 <code>Bundle</code> 的 <code>Wire</code>，根据需要设置各个字段，然后将此 <code>Bundle</code> 传递给 <code>RegInit</code>。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">initVal</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Channel</span><span class="p">())</span>
<span class="n">initVal</span><span class="p">.</span><span class="n">data</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span>
<span class="n">initVal</span><span class="p">.</span><span class="n">valid</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span>
<span class="kd">val</span><span class="w"> </span><span class="n">channelReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="n">initVal</span><span class="p">)</span>
</code></pre></div>
<p>！！！注意，部分赋值在 Chisel 中是不允许的。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">assignWord</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="n">assignWord</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">lowByte</span><span class="w">           </span><span class="c1">// WRONG!!!</span>
<span class="n">assignWord</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">highByte</span><span class="w">          </span><span class="c1">// WRONG!!!</span>
</code></pre></div>
<p>在这种情况下，应该使用 <code>Bundle</code> 类型。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">assignWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Split</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="kd">val</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">val</span><span class="w"> </span><span class="n">split</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Split</span><span class="p">())</span>
<span class="n">split</span><span class="p">.</span><span class="n">low</span><span class="w">  </span><span class="o">:=</span><span class="w"> </span><span class="n">lowByte</span>
<span class="n">split</span><span class="p">.</span><span class="n">high</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">highByte</span>
<span class="n">assignWord</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">split</span><span class="p">.</span><span class="n">asUInt</span><span class="p">()</span><span class="w">    </span><span class="c1">// casting that bundle with asUInt() to a UInt</span>
</code></pre></div>
<p>该解决方案的一个缺点是需要知道 <code>Bundle</code> 字段以何种顺序合并为单个向量。</p>
<h3 id="wire-reg-io">Wire, Reg 和 IO<a class="headerlink" href="#wire-reg-io" title="Permanent link">&para;</a></h3>
<p><code>UInt</code>、<code>SInt</code> 和 <code>Bits</code> 是 Chisel 类型，它们本身并不代表硬件。
将它们封装到 <code>Wire</code>、<code>Reg</code> 或 <code>IO</code> 中才能生成硬件。
<code>Wire</code> 代表组合逻辑，<code>Reg</code> 代表寄存器（D 触发器的集合），<code>IO</code> 代表模块的连接（电路的引脚）。
任何 Chisel 类型都可以封装在 <code>Wire</code>、<code>Reg</code> 或 <code>IO</code> 中。</p>
<p>你可以通过 Scala 不可变变量来创建一个硬件。
使用 Chisel 运算符 <code>:=</code> 将值或表达式分配（或重新分配）到 <code>Wire</code>、<code>Reg</code> 或 <code>IO</code>。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="nc">UInt</span><span class="p">())</span>
<span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">SInt</span><span class="p">())</span>

<span class="n">number</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="nc">U</span>
<span class="n">reg</span><span class="w">       </span><span class="o">:=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span>
</code></pre></div>
<p>请注意 Scala 赋值运算符 <code>=</code> 和 Chisel 运算符 <code>:=</code> 之间的差别。
创建硬件对象（并为其命名）时使用 Scala 的 <code>=</code> 运算符，但在为现有硬件对象赋值时使用 Chisel 的 <code>:=</code> 运算符。</p>
<h2 id="_6">模块<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="module">Module 类<a class="headerlink" href="#module" title="Permanent link">&para;</a></h3>
<p>硬件组件（hardware components）在 Chisel 中称为模块（module）。
每个模块都继承自类 <code>Module</code> 并用 <code>io</code> 字段表示接口。
接口由 <code>Bundle</code> 定义，并被封装在 <code>IO()</code> 中。
<code>Bundle</code> 中包含表示模块输入和输出端口的字段。
通过将信号封装到 <code>Input()</code> 或 <code>Output()</code> 中来定义方向。
方向是从模块本身的角度来看的。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// an adder</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Adder</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span>
<span class="p">}</span>

<span class="c1">// a register</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Register</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span>
<span class="w">    </span><span class="n">reg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">d</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">q</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">reg</span>
<span class="p">}</span>
</code></pre></div>
<p>由上述加法器和寄存器模块组成的计数器定义如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Count10</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">dout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Adder</span><span class="p">())</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Register</span><span class="p">())</span>

<span class="w">    </span><span class="c1">// the register output</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reg</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">q</span>

<span class="w">    </span><span class="c1">// connect the adder</span>
<span class="w">    </span><span class="n">add</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span>
<span class="w">    </span><span class="n">add</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">count</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">y</span>

<span class="w">    </span><span class="c1">// connect the Mux and the register input</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">)</span>
<span class="w">    </span><span class="n">reg</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">d</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">next</span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">dout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">count</span>
<span class="p">}</span>
</code></pre></div>
<p>实例化的过程是使用 <code>new</code> 声明，并将它封装到 <code>Module()</code> 中。</p>
<h3 id="bulk-connections">Bulk Connections<a class="headerlink" href="#bulk-connections" title="Permanent link">&para;</a></h3>
<p>为了连接具有多个 IO 端口的模块，Chisel 提供了批量连接运算符 <code>&lt;&gt;</code>。
Chisel 会将 <code>io</code> 字段中名称相同的端口连接起来。
如果没有匹配的名称，那么该端口会悬空。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Fetch</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="c1">// ... Implementation of fetch</span>
<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Decode</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">instr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">aluOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">5</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">regA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">regB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="c1">// ... Implementation of decode</span>
<span class="p">}</span>

<span class="kd">val</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Fetch</span><span class="p">())</span>
<span class="kd">val</span><span class="w"> </span><span class="n">decode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Module</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Decode</span><span class="p">())</span>

<span class="n">fetch</span><span class="p">.</span><span class="n">io</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">decode</span><span class="p">.</span><span class="n">io</span>
</code></pre></div>
<p>我们也可以将子模块的端口与父模块连接。</p>
<div class="highlight"><pre><span></span><code><span class="n">io</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">execute</span><span class="p">.</span><span class="n">io</span>
</code></pre></div>
<h3 id="chisel">内嵌非 Chisel 代码<a class="headerlink" href="#chisel" title="Permanent link">&para;</a></h3>
<p>Verilog 描述的模块可以通过 <code>ExtModule</code> 和 <code>BlackBox</code> 类内嵌在 Chisel 中。</p>
<p>两者都可以在定义的时候使用 <code>Map[String, Param]</code> ，它们在生成的 Verilog 代码中表示模块的参数。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BUFGCE</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="p">(</span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;SIM_DEVICE&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;7SERIES&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nc">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Clock</span><span class="p">())</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nc">CE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nc">O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Clock</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<p>上述代码中 <code>Map("SIM_DEVICE" -&gt; "7SERIES")</code> 生成的 Verilog 代码为 <code>parameter SIM_DEVICE = "7SERIES"</code>。</p>
<h4 id="extmodule">ExtModule<a class="headerlink" href="#extmodule" title="Permanent link">&para;</a></h4>
<p><code>ExtModules</code> 充当占位符，其生成的 Verilog 代码是模块的实例化（不会生成模块的定义）。
一个常见的例子是使用 <code>ExtModule</code> 来表示 FPGA 上的 IP。</p>
<h4 id="blackbox">BlackBox<a class="headerlink" href="#blackbox" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BlackBoxAdderIO</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">32</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PathBlackBoxAdder</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">HasBlackBoxPath</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">BlackBoxAdderIO</span><span class="p">)</span>
<span class="w">    </span><span class="n">addPath</span><span class="p">(</span><span class="s">&quot;./src/main/resources/PathBlackBoxAdder.v&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>上述代码中的 <code>addPath</code> 函数指定了 Verilog 模块的路径。</p>
<p>注意，<code>HasBlackBoxPath</code> 是 <code>BlackBox</code> 类的特征（trait），这意味着 <code>class Example extends BlackBox with HasBlackBoxInline</code> 等价于 <code>class Example extends HasBlackBoxInline</code>。</p>
<h2 id="_7">组合逻辑基本模块<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="_8">组合逻辑电路<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>最简单的组合逻辑形式是布尔表达式，可以为其指定一个名称：</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">c</span>
</code></pre></div>
<p>该表达式可以在其他表达式中重用：</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">e</span>
</code></pre></div>
<p>这样组合逻辑的表达式被认为是常量（根本原因是使用了 Scala 的 <code>val</code>）。
使用 <code>=</code> 给 e 赋值会导致 Scala 编译器错误：<code>reassignment to val</code>。
尝试使用Chisel运算符 <code>:=</code> 会导致错误：<code>Cannot reassign to read-only.</code>。</p>
<p>但是，当我们对组合电路进行条件更新（conditional update）时，我们可以对同一变量进行多次赋值。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">WireDefault</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span>

<span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">w</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">.</span><span class="n">elsewhen</span><span class="w"> </span><span class="p">(</span><span class="n">cond2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">w</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="nc">U</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">.</span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">w</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>在创建 <code>Wire</code> 时定义默认值可以有效防止锁存器的生成。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">WireDefault</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
</code></pre></div>
<p>注意 <code>.elsewhen</code> 中的 <code>.</code> 不能忽略。</p>
<h3 id="_9">多选器<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>Chisel 提供了多选器的抽象：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</code></pre></div>
<p>当 <code>sel</code>为 <code>true.B</code> 时选择 a，否则选择b。<code>sel</code> 的类型是 Chisel <code>Bool</code>；输入 a 和 b 可以是任何 Chisel 基本类型或聚合类型（aggregate such as bundles and vectors），只要它们是相同类型即可。</p>
<h3 id="_10">解码器<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>我们可以用真值表来描述解码器的功能。
Chisel 中的 <code>switch</code> 语句用来将逻辑描述为真值表。
要使用 <code>switch</code> 语句，我们需要导入一个Chisel包：<code>import chisel3.util._</code>。</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">chisel3</span><span class="p">.</span><span class="nn">util</span><span class="p">.</span><span class="n">_</span>

<span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span>

<span class="n">switch</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">is</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">}</span>
<span class="w">    </span><span class="n">is</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="nc">U</span><span class="p">}</span>
<span class="w">    </span><span class="n">is</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="nc">U</span><span class="p">}</span>
<span class="w">    </span><span class="n">is</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="nc">U</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>注意，即使我们枚举所有可能的输入值，Chisel 仍然需要我们指定一个默认值。
该默认值永远不会被使用，因此会被综合工具优化掉。
这种做法的目的是避免组合电路生成锁存器。</p>
<p>我们也可以用 Chisel 移位操作 <code>&lt;&lt;</code> 来表示解码器。</p>
<div class="highlight"><pre><span></span><code><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sel</span>
</code></pre></div>
<h3 id="_11">编码器<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>为了描述更大的编码器，我们需要编写一个硬件生成器（hardware generator）。
因此，我们需要引入 Scala 循环结构。</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Wire</span><span class="p">(</span><span class="nc">Vec</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">)))</span>
<span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span>

<span class="w"> </span><span class="c1">// Loops i from 0 to 15</span>
<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">hotIn</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w"> </span><span class="p">}</span>
<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">encOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</code></pre></div>
<p>编码器的输入是 <code>hotIn</code>，输出是 <code>encOut</code>。<code>Vec</code> 元素 <code>0</code> 是默认值（0），也表示 <code>hotIn</code> 中最低有效位 (LSB) 为 1 时的输出值。</p>
<p>如果 <code>hotIn</code> 中位置 <code>i</code> 处 bit 值为 1，则多选器输出为该索引 <code>i</code>，否则为 0。
最后，我们需要合并所有向量元素以获得单个输出。
由于当输入中对应位为 0 时向量元素为 0，因此我们可以简单地使用 OR 函数将所有元素组合起来。
我们称这个操作为归约（reduce）。
这里我们执行 OR 归约 （OR reduction）。</p>
<h3 id="_12">仲裁器<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>我们实现一个 3-bit 的仲裁器。
它由 3 条请求信号（r0-r2）和 3 条许可信号（g0-g2）组成。
仲裁器每次只会响应一个请求信号，并优先选择编号较小的请求信号。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">grant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VecInit</span><span class="p">(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">notGranted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VecInit</span><span class="p">(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>

<span class="n">grant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">request</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">notGranted</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">grant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">grant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">request</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">notGranted</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">notGranted</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">grant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">notGranted</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">grant</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">request</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">notGranted</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>对于更大的仲裁器，我们需要使用循环结构。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">grant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VecInit</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">n</span><span class="p">)(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">notGranted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">VecInit</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="n">n</span><span class="p">)(</span><span class="kc">false</span><span class="p">.</span><span class="nc">B</span><span class="p">)</span>

<span class="n">grant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">request</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">notGranted</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">grant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">grant</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">request</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">notGranted</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">notGranted</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">!</span><span class="n">grant</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">notGranted</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>使用循环与手写版本的差别是，我们为最后一个请求信号（n-1）生成了 <code>notGranted</code> 信号。
该信号未被使用，因此综合工具会将其优化掉。</p>
<h3 id="_13">优先编码器<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>在我们最初的编码器设计中，我们假设输入是单热编码（one-hot encoded）的，这意味着只允许一位为 1。
多个位都是1的输入是非法的，会导致未定义的行为。</p>
<p>我们可以通过将编码器与仲裁电路相结合来解决这个问题，仲裁电路仅选择最高优先级的位。</p>
<h3 id="_14">比较器<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>比较只需要一行代码就可以完成。
因此，比较函数通常直接在其他模块中使用，而不是封装成一个单独的模块。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">equ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">b</span>
<span class="kd">val</span><span class="w"> </span><span class="n">gt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span>
</code></pre></div>
<h2 id="_15">时序逻辑基本模块<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<h3 id="_16">计数器<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="n">cntReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">cntReg</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span>
</code></pre></div>
<p>也可以用 <code>when</code> 来实现：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>

<span class="n">cntReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span>
<span class="n">when</span><span class="p">(</span><span class="n">cntReg</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nc">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cntReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span>
<span class="p">}</span>
</code></pre></div>
<p>如果我们需要很多不同的计数器，我们可以先定义一个带有参数的函数，然后调用该函数来创建计数器。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// This function returns a counter</span>
<span class="k">def</span><span class="w"> </span><span class="nf">genCounter</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="n">cntReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">cntReg</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span>
<span class="w">    </span><span class="n">cntReg</span><span class="w">  </span><span class="c1">// the return value of the function</span>
<span class="p">}</span>
<span class="c1">// now we can easily create many counters</span>
<span class="kd">val</span><span class="w"> </span><span class="n">count10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genCounter</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">count99</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genCounter</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span>
</code></pre></div>
<h3 id="_17">计时器<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>数字定时器首先设定倒计时时长，然后倒计时直到为零。
计时器为零时置位完成信号。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="kd">val</span><span class="w"> </span><span class="n">done</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span>
<span class="kd">val</span><span class="w"> </span><span class="n">next</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nc">WireDefault</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span>

<span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">load</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">next</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">din</span>
<span class="p">}</span><span class="w"> </span><span class="p">.</span><span class="n">elsewhen</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">done</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">next</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span>
<span class="p">}</span>
<span class="n">cntReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">next</span>
</code></pre></div>
<h3 id="_18">脉冲宽度调制<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>脉宽调制（PWM）是一种具有恒定周期的信号，并对该周期内信号的高电平时间进行调制。
信号为高电平的时间百分比称为占空比（duty cycle）。</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pwm</span><span class="p">(</span><span class="n">nrCycles</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">din</span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="n">unsignedBitLength</span><span class="p">(</span><span class="n">nrCycles</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nc">W</span><span class="p">))</span>
<span class="w">    </span><span class="n">cntReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">cntReg</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="p">(</span><span class="n">nrCycles</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">,</span><span class="w"> </span><span class="n">cntReg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="nc">U</span><span class="p">)</span>
<span class="w">    </span><span class="n">din</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cntReg</span><span class="w">    </span><span class="c1">//  return value</span>
<span class="p">}</span>

<span class="kd">val</span><span class="w"> </span><span class="n">din</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="nc">U</span>
<span class="kd">val</span><span class="w"> </span><span class="n">dout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pwm</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">din</span><span class="p">)</span>
</code></pre></div>
<p>我们定义了一个 PWM 生成器的函数。
该函数有两个参数：一个 Scala 整数，用于配置 PWM 的时钟周期数（<code>nrCycles</code>）；以及一个 Chisel Wire（<code>din</code>），用于给出 PWM 输出信号的占空比（脉冲宽度）。</p>
<p>我们使用函数 <code>unsignedBitLength(n)</code> 来指定计数器 <code>cntReg</code> 所需的位数（对于无符号数n，至少需要 <span class="arithmatex">\(\lfloor\log_2\rfloor(n)+1\)</span>位）。
Chisel 还有一个函数 <code>signedBitLength</code> 用于提供有符号数的位数。</p>
<h3 id="_19">移位寄存器<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>移位寄存器的一个使用场景是数据的串并转换。
最简单的移位寄存器用 Chisel 很容易实现。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">shiftReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="n">shiftReg</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="n">shiftReg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">din</span>
<span class="kd">val</span><span class="w"> </span><span class="n">dout</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">shiftReg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<p>串进并出的移位寄存器实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">outReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="n">outReg</span><span class="w">    </span><span class="o">:=</span><span class="w"> </span><span class="n">serIn</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">outReg</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">q</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">outReg</span>
</code></pre></div>
<p>并进串出的移位寄存器实现如下：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="n">loadReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegInit</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">load</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">loadReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">d</span>
<span class="p">}</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">loadReg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="nc">U</span><span class="w"> </span><span class="o">##</span><span class="w"> </span><span class="n">loadReg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">val</span><span class="w"> </span><span class="n">serOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadReg</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<h3 id="_20">内存<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>Chisel 提供了 <code>SyncReadMem</code> 用来快速构建寄存器阵列。
如下是一个同步读写内存的例子：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Memory</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">rdAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">rdData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">wrAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">wrData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">wrEna</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SyncReadMem</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">rdData</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">rdAddr</span><span class="p">)</span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">wrEna</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mem</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">wrAddr</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">wrData</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>一个有趣的问题是，当在同一时钟周期内读写同一地址时，读的返回值是什么。
如果我们想读出新写入的值，我们可以构建一个前递（forward）电路，检测地址是否相等并前递写入的数据。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ForwardingMemory</span><span class="p">()</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">IO</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">rdAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">rdData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">wrAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">wrData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">wrEna</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="nc">Bool</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">SyncReadMem</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="p">.</span><span class="nc">W</span><span class="p">))</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wrDataReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">wrData</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">doForwardReg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">wrAddr</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">rdAddr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">wrEna</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">memData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">rdAddr</span><span class="p">)</span>

<span class="w">    </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">wrEna</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mem</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">wrAddr</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">wrData</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">rdData</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">Mux</span><span class="p">(</span><span class="n">doForwardReg</span><span class="p">,</span><span class="w"> </span><span class="n">wrDataReg</span><span class="p">,</span><span class="w"> </span><span class="n">memData</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.caa56a14.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>